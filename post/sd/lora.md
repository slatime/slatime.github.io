## LoRA

Stable Diffusion 시리즈 모델을 사용하여 이미지를 생성하는 경우

> '특정 캐릭터의 일러스트를 만들고 싶다'<br>
'특정 애니메이션의 패턴을 재현하고 싶습니다.'<br>

이런 욕구가 생길 수 있습니다. 하지만 이미지 생성 AI가 그대로 "결정에 의해 특정 디자인/캐릭터 제공"이 매우 어렵고, 이를 해결하기 위한 기술이 있지만 고성능 PC가 필요합니다. 시간이 걸리고 문제가 있었습니다.

그러나 이러한 문제를 해결하기 위한 '로라(LoRA)'라는 기술이 알려지면서 현재 꽤 대중화되고 있습니다. 여기서는 이 로라(LoRA)에 대해 이야기하겠습니다.

## LoRA 개요
 - LoRA는 'Low-Rank Adaptation'의 줄임말로 단적으로 말하면 **기존 모델에 새로운 피사체를 학습시키는 추가 학습 기법의 일종**입니다.
  
예를 들어, Stable Diffusion 계열의 모델을 사용해 「특정 캐릭터의 일러스트」를 생성하는 경우를 생각해 보겠습니다.<br>
이때 보통은 프롬프트에 목적을 둔 캐릭터의 특징을 나타내는 키워드를 포함하여 해당 캐릭터에 가까운 일러스트가 나올 때까지 뽑기를 반복이 필요합니다. 하지만 이 방법에는

> '모델의 학습에 포함되지 않은 것 같은 마이너한 캐릭터라면 아무리 좋아도 '비슷한' 수준의 일러스트밖에 나오지 않는다.'<br>
'유명 캐릭터라도 뭔가 다른 캐릭터가 되어 버리는 경우가 있다.'<br>
'목표 이미지가 생성될 때까지 계속해서 뽑기를 해야 한다'

는 문제점이 있습니다. 그래서 만약 가능하다면 목표 캐릭터가 결정적으로 나왔으면 할것입니다. 이 문제를 해결하기 위해서 기존 모델을 목표로 한 캐릭터가 나오도록 조정하는것이 추가학습입니다.

일단로라(LoRA)는 이 추가 학습기법의 일종이라고 생각하시면 될 것 같습니다.

## LoRA 예
 > [조건]<br>
> - '학습 데이터 : 나의 오리지널 캐릭터 '얼룩양이' 일러스트 15장'<br>
> - '사용 모델: Stable Diffusion v1.5'<br>
> - '에퍼크 수: 10'

![img](/images/lora1.png)

이를 이용하여 로라(LoRA)에서 학습을 수행하고 그 결과를 사용하여 자동 생성한 이미지 예는 아래와 같습니다. 

| LoRA를 이용해 생성한 얼룩고양이 예시(1)        | LoRA를 이용해 생성한 얼룩고양이 예시(2)           | LoRA를 이용해 생성한 얼룩고양이 예시(3)  |
| :-------------: |:-------------:| :-----:|
| ![img](/images/lora2.png)      | ![img](/images/lora3.png) | ![img](/images/lora4.png) |


### 다른 추가 학습법(DreamBooth 등)과의 차이점

그런데 추가 학습이라고 하면 로라(LoRA) 뿐만 아니라 'DreamBooth' 등 다른 기법도 있는데, 그와 비교하면 로라(LoRA)의 강점은

> '다른 방법보다 훨씬 짧은 시간에 학습시킬 수 있다'<br>
> '비교적 낮은 사양의 PC에서도 학습 처리 가능'<br>
> '학습 결과 모델 파일은 매우 가볍다'

특히 시간 단축이 가능한 점과 스펙이 다소 낮은 PC에서도 처리를 할 수 있는 점은 강해 글을 쓴 시점에서는 가장 대중적인 수법이 되고 있는 것 같습니다.

### 필요한 PC 스펙(주로 그래픽카드가 중요)

> 최소 6GB, 가능하면 10GB 이상의 VRAM(비디오 메모리)이 있는 그래픽 보드를 탑재하고 있을 것

즉 이미지 생성을 할 때와 마찬가지로 그래픽 보드의 성능이 매우 중요합니다. 그래서 만약 성능이 부족하다면 교체를 검토하는 것이 좋습니다.

### 학습에 필요한 데이터에 대해서
다음으로 학습에는 학습이 되는 데이터가 필요하기 때문에 그것에 대해 설명하겠습니다. 사실 로라(LoRA)를 이용한 학습 방법에는 주로 다음 두 가지 방법이 있습니다.

> - 1. DreamBooth 방식 : 학습 데이터와 정칙화 이미지를 사용하여 학습시키는 방법 <br>
> - 2. 파인튠 방식: 학습 데이터와 캡션 파일을 사용하여 학습시키는 방법

어느 쪽이든 원하는 방법을 사용하셔도 괜찮습니다만, 아래에서는 첫 번째 DreamBooth 방식으로 학습을 실시하는 것으로 합니다. 이 경우 학습에는 다음 두 종류의 데이터가 필요합니다.
> - 학습 데이터가 되는 이미지
> - 정칙화 이미지

### 학습데이터 
먼저 학습 데이터입니다.아래 요건을 충족한 이미지가 최소 20매 이상 필요합니다.

> - '학습시키고 싶은 피사체가 단독으로 찍혀 있다'
> - '이미지마다 여러 가지 포즈를 취하고 있다'
> - '이미지마다 여러 가지 배경이 찍혀 있다'
> - '난잡한 그림, 특이한 그림들은 제외한다'<br>
> (AI가 봤을때 피사체와 배경구분이 잘 안되는 사진, 이펙트가 너무 화려한 사진, 어떤 물건이 나물에 피사체의 일부가 가려진 사진 등.)

너무 비슷한 포즈나 비슷한 배경만 있는 이미지를 학습시키면 그것을 강하게 기억하게 되므로 주의해야 합니다. 또 당연하지만 학습 데이터는 적은 것보다는 많은 것이 좋습니다. 질, 양을 모두 고려하여 모읍시다.

### 정칙화 이미지 
그리고 하나 더 필요한 것이 정칙화 이미지입니다. 학습 대상이나 용도에 따라 다르지만, 일반적으로 학습에서는 이 정칙화 이미지가 대량으로 필요합니다(※만드는 방법은 후술합니다).

정칙화 이미지란 간단히 말하면

프롬프트에 포함된 단어의 개념이 바뀌지 않도록 하기 위한 학습용 이미지 라는 것입니다. …라고 해도 이 설명이라면 의미가 불분명할 것 같아서 조금 더 설명하겠습니다.

참고할 사항으로 일단 이미지 준비로는 * 로라(LoRA)의 버킷 기능(자동 크기 조정 및 자르기) 덕분에 이미지를 자를 필요가 없습니다. 트레이닝 해상도가 512X512라도 이미지를 512 x 512로 준비할 필요가 없다는 뜻입니다. 원본 이미지에서 쓸데없는 부분만 잘라내는 방식으로 합니다.

## LoRA 환경구축

## LoRA 학습방법

## Stable Diffusion Web UI에서 LoRA 모델 사용법



https://loodyrunning.tistory.com/2725